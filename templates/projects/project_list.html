<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>案件一覧</title>

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />

  <!-- Font Awesome（アイコン用） -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      min-height: 100vh;
      display: flex;
      margin: 0;
    }

    .sidebar {
      width: 220px;
      background-color: #f8f9fa;
      padding: 20px;
      border-right: 1px solid #ddd;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
    }

    .content {
      flex-grow: 1;
      padding: 20px;
    }

    .project-detail-preview {
      max-height: 4.5em;
      overflow: hidden;
      position: relative;
    }

    .project-detail {
      white-space: normal;
      line-height: 1.6;
      word-break: break-word;
    }

    .table td {
      vertical-align: top;
    }

    .show-more {
      margin-top: 5px;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <!-- サイドバー -->
  <div class="sidebar">
    <div>
      <h5>案件検索</h5>

      <form method="get" action="{% url 'project_list' %}">
        <div class="mb-3">
          <input
            type="text"
            name="keyword"
            class="form-control"
            placeholder="キーワード検索"
            value="{{ request.GET.keyword|default_if_none:'' }}"
          >
        </div>

        <div class="mb-3">
          <button type="submit" class="btn btn-primary w-100">検索</button>
        </div>
      </form>

      <hr>

      <ul class="list-unstyled">
        <li><a href="{% url 'project_list' %}">すべての案件</a></li>
        <li><a href="{% url 'project_list' %}?status=open">募集中</a></li>
        <li><a href="{% url 'project_list' %}?status=closed">募集終了</a></li>
      </ul>
    </div>

    <!-- 管理画面リンク -->
    <div class="mt-4">
      <a href="{% url 'admin:index' %}" class="text-decoration-none text-muted d-flex align-items-center">
        <i class="fas fa-cog me-2"></i> 管理画面
      </a>
    </div>
  </div>

<!-- メインコンテンツ -->
<div class="content">
  <form method="post" action="{% url 'export_selected_projects_with_gpt' %}">
    {% csrf_token %}

    <div class="d-flex justify-content-between align-items-center mb-3">
      <h2 class="mb-0">案件一覧</h2>
      <button type="submit" class="btn btn-outline-primary">
        <i class="fas fa-file-export me-1"></i> 選択した案件をExcel出力
      </button>
    </div>


      <table class="table table-striped table-hover align-middle">
        <thead class="table-light">
          <tr>
            <th><input type="checkbox" id="select-all"></th>
            <th>顧客名</th>
            <th>案件詳細</th>
            <th>募集状況</th>
          </tr>
        </thead>
        <tbody>
          {% for project in projects %}
          <tr>
            <td>
              <input type="checkbox" name="selected_ids" value="{{ project.id }}">
            </td>
            <td>{{ project.customer_name }}</td>
            <td>
              <div class="project-detail project-detail-preview" id="preview-{{ forloop.counter }}">
                {{ project.detail|linebreaksbr }}
              </div>
              <div class="collapse project-detail" id="detail-{{ forloop.counter }}">
                {{ project.detail|linebreaksbr }}
              </div>
              <button class="btn btn-link p-0 show-more"
                type="button"
                data-bs-toggle="collapse"
                data-bs-target="#detail-{{ forloop.counter }}"
                aria-expanded="false"
                aria-controls="detail-{{ forloop.counter }}"
                id="toggle-btn-{{ forloop.counter }}"
                onclick="togglePreview({{ forloop.counter }})">
                詳細を見る
              </button>
            </td>
            <td>
              {% if project.status == 'open' %}
                <span class="badge bg-success">募集中</span>
              {% else %}
                <span class="badge bg-secondary">募集終了</span>
              {% endif %}
            </td>
          </tr>
          {% empty %}
          <tr>
            <td colspan="4" class="text-center">案件がありません</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </form>
  </div>

  <!-- Bootstrap & Script -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // 「全選択」チェックボックスの動作
    document.getElementById('select-all').addEventListener('change', function () {
      const checkboxes = document.querySelectorAll('input[name="selected_ids"]');
      checkboxes.forEach(cb => cb.checked = this.checked);
    });

    // 詳細表示トグル関数
    function togglePreview(index) {
      const preview = document.getElementById(`preview-${index}`);
      const collapse = document.getElementById(`detail-${index}`);
      const button = document.getElementById(`toggle-btn-${index}`);

      if (!collapse.dataset.listenerAdded) {
        collapse.addEventListener('shown.bs.collapse', function () {
          button.textContent = '詳細を閉じる';
          preview.style.display = 'none';
        });
        collapse.addEventListener('hidden.bs.collapse', function () {
          button.textContent = '詳細を見る';
          preview.style.display = '';
        });
        collapse.dataset.listenerAdded = true;
      }
    }
  </script>
</body>
</html>
